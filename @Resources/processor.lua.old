function Initialize()
	local parent = [=[
[P]
Measure=Plugin
Plugin=AudioAnalyzer
Type=Parent
FreqList_0=Log (#Bands#+1) #FreqMin# #FreqMax#
Processing=]=]
	local group = [=[
Processing_NUM=Channels #Channel# | Handlers PNUMH1,PNUMH2,PNUMH3,PNUMH4,PNUMH5,NUM
Handler_PNUMH1=Type FFT | Attack #Attack# | Decay #Decay# | BinWidth #AccuracyNUM# | Overlap #OverlapNUM# | CascadesCount #CascadesNUM#
Handler_PNUMH2=Type BandResampler | Source PNUMH1 | FreqList 0 | ProportionalValues 0
Handler_PNUMH3=type WeightedBlur | Source PNUMH2 | minRadius #Blur# | maxRadius 100 | MinRadiusAdaptation 1
Handler_PNUMH4=Type BandCascadeTransformer | Source PNUMH3 | MixFunction #MixFunction# | TargetWeight 100 | MinWeight 0 | WeightFallback 1
Handler_PNUMH5=Type FiniteTimeFilter | Source PNUMH4 | SmoothingFactor #BandAvgSize# | SmoothingCurve #BandAvgType# | ExponentialFactor #BandAvgBase#
Handler_NUM=Type LogarithmicValueMapper | Source PNUMH5 | Sensitivity #Sensitivity# | Offset #ValueOffset#
]=]
	local band = [=[
[NUM]
Measure=Plugin
Plugin=AudioAnalyzer
Parent=P
ValueId=0
Index=NUM
Channel=#Channel#
Clamp01=0
]=]
	bands = SKIN:GetVariable('Bands', 0)
	local file = io.open(SKIN:GetVariable('CURRENTPATH') .. 'bands.inc')
	if file then
		bandCount = file:read()
		file:close()
	end
	if bands ~= (bandCount or nil) then
		local section = {bands..string.char(10)}
		for i=1,bands+1 do
			section[i+1] = string.gsub(band, 'NUM', i-1)
		end
		local file = io.open(SKIN:GetVariable('CURRENTPATH') .. 'bands.inc', 'w')
		file:write(table.concat(section))
		file:close()
	end
	
	groups = SKIN:GetVariable('Groups', 0)
	local file = io.open(SKIN:GetVariable('CURRENTPATH') .. 'parent.inc')
	if file then
		groupCount = file:read()
		file:close()
	end
	if groups ~= (groupCount or nil) then
		local section = {groups..string.char(10)..parent..'0'}
		for i=1,groups-1 do
			section[i+1] = '|' .. i
		end
		section = {table.concat(section)..string.char(10)}
		for i=1,groups do
			section[i+1] = string.gsub(group, 'NUM', i-1)
		end
		local file = io.open(SKIN:GetVariable('CURRENTPATH') .. 'parent.inc', 'w')
		file:write(table.concat(section))
		file:close()
	end
	
	local file = io.open(SKIN:GetVariable('CURRENTPATH') .. 'variables.inc')
	if file then
		file:close()
	else
		os.execute('copy "' .. SKIN:GetVariable('@') .. 'defaultvariables.inc" "' .. SKIN:GetVariable('CURRENTPATH') .. 'variables.inc"')
	end
	
	if (bands ~= (bandCount or nil)) or (groups ~= (groupCount or nil)) then
		SKIN:Bang('!Refresh')
		return
	end
	
	--timer
	st = 0
	el = 0
	st2 = os.clock()
	el2 = 0
	st3 = os.clock()
	el3 = 0
	st4 = os.clock()
	el4 = 0
	eli = 0
	--timer
	
	visType = string.upper(SKIN:GetVariable('Type', 'BAR'))
	visType = ((visType == "BAR" and 1) or (visType == "POLY" and 2)) or 1
	
	colorType = string.upper(SKIN:GetVariable('Color', 'CUSTOM'))
	colorType = ((colorType == "CUSTOM" and 1) or (colorType == "CHAMELEON" and 2)) or 1
	
	scale = SKIN:GetVariable('Scale', 1)
	
	barSpacing = SKIN:GetVariable('BarSpacing', 0)
	width = SKIN:GetVariable('Width', 0)
	barWidth = SKIN:GetVariable('BarWidth', 0)
	height = SKIN:GetVariable('Height', 0)
	baseHeight = SKIN:GetVariable('BaseHeight', 0)
	trueHeight = height-baseHeight
	
	invert = string.upper(SKIN:GetVariable('Invert', 'NO'))
	invert = ((invert == "YES" and 1) or (colorType == "NO" and 2)) or 2
	
	avgType = string.upper(SKIN:GetVariable('ProcAvgType', 'FLAT'))
	avgType = (((avgType == "FLAT" and 1) or (avgType == "LINEAR" and 2)) or (avgType == "EXPONENTIAL" and 3)) or 1
	avgConst = 0
	avgSize = SKIN:GetVariable('ProcAvgSize', 1)
	avgBase = SKIN:GetVariable('ProcAvgBase', 1)
	avgIndex = 0
	
	gain = math.log10(SKIN:GetVariable('Gain', 10))
	power = SKIN:GetVariable('Power', 1)
	
	bSrc = {}
	bAvg = {{}}
	cutoff = {}
	
	for i=1,groups-1 do
		cutoff[i] = SKIN:GetVariable('Cutoff' .. i-1, 0)
	end
	
	for i=1,bands do
		bSrc[i] = SKIN:GetMeasure(i)
		for j=groups-1,1,-1 do
			if i<bands*cutoff[j] then
				SKIN:Bang('!SetOption', i, 'ValueId', j)
				break
			end
		end
	end
	
	if avgSize == 1 then
		avgConst = 1
	else
		if avgType == 1 then
			avgConst = 1/avgSize
		elseif avgType == 2 then
			avgConst = 1/(avgSize*(avgSize+1)/2)
		elseif avgType == 3 then
			weight = 1
			for i=1,avgSize do
				avgConst = avgConst + weight
				weight = weight * avgBase
			end
			avgConst = 1/avgConst
		end
	end
	
	for i=1,avgSize do
		bAvg[i] = {}
	end
	
	if colorType == 1 then
		SKIN:Bang('!SetOption', 'Shape', 'Color', 'FillColor#Custom#,#Alpha#|StrokeWidth0')
	elseif colorType == 2 then
		SKIN:Bang('!SetOption', 'Shape', 'Color', 'FillColor[RGB],#Alpha#|StrokeWidth0')
	end
	
	if visType == 1 then
		SKIN:Bang('!SetOption', 'Shape', 'TransformationMatrix', '(Cos(-#Angle#%360*Pi/180));(-Sin(-#Angle#%360*Pi/180));(Sin(-#Angle#%360*Pi/180));(Cos(-#Angle#%360*Pi/180));(((90<#Angle#%360)&(#Angle#%360<270)?Abs(Cos(#Angle#%360*Pi/180))*(#BarWidth#+#barSpacing#)*#Points#*#Scale#:0)+((0<#Angle#%360)&(#Angle#%360<180)?Abs(Sin(#Angle#%360*Pi/180))*#Height#*#Scale#:0));(((180<#Angle#%360)&(#Angle#%360<360)?Abs(Sin(#Angle#%360*Pi/180))*(#BarWidth#+#barSpacing#)*#Points#*#Scale#:0)+((90<#Angle#%360)&(#Angle#%360<270)?Abs(Cos(#Angle#%360*Pi/180))*#Height#*#Scale#:0))')
		SKIN:Bang('!SetOption', 'Shape', 'Shape', 'Rectangle0,0,0,0')
	elseif visType == 2 then
		SKIN:Bang('!SetOption', 'Shape', 'TransformationMatrix', '(Cos(-#Angle#%360*Pi/180));(-Sin(-#Angle#%360*Pi/180));(Sin(-#Angle#%360*Pi/180));(Cos(-#Angle#%360*Pi/180));(((90<#Angle#%360)&(#Angle#%360<270)?Abs(Cos(#Angle#%360*Pi/180))*#Width#*#Scale#:0)+((0<#Angle#%360)&(#Angle#%360<180)?Abs(Sin(#Angle#%360*Pi/180))*#Height#*#Scale#:0));(((180<#Angle#%360)&(#Angle#%360<360)?Abs(Sin(#Angle#%360*Pi/180))*#Width#*#Scale#:0)+((90<#Angle#%360)&(#Angle#%360<270)?Abs(Cos(#Angle#%360*Pi/180))*#Height#*#Scale#:0))')
		SKIN:Bang('!SetOption', 'Shape', 'Path', '0,0|LineTo0,0')
		SKIN:Bang('!SetOption', 'Shape', 'Shape', 'PathPath|ExtendColor')
		--SKIN:Bang('!SetOption', 'Shape', 'Shape', 'PathPath|FillColor000000|StrokeWidth0')
		--SKIN:Bang('!SetOption', 'Shape', 'Shape2', 'Rectangle0,0,' .. width*scale .. ',' .. height*scale .. '|ExtendColor')
		--SKIN:Bang('!SetOption', 'Shape', 'Shape3', 'Combine Shape2|IntersectShape')
		path = {'0,' .. height*scale}
		for i=1,bands do
			path[i*2] = '|LineTo' .. (i-1)*width/(bands-1)*scale .. ','
		end
		path[2+bands*2] = '|LineTo' .. width*scale .. ',' .. height*scale .. '|Closepath1'
	end
	
	SELF:Enable()
end
function Update()

	--timer
	st=os.clock()
	--timer
	
	local c = {}
	local bCalc = {}
	avgIndex = (avgIndex + 1) % avgSize
	k = avgIndex + 1
	for i=1,bands do
		local b = bSrc[i]:GetValue()
		if b < 0 then bCalc[i] = 0 else bCalc[i] = (b*gain)^power end
	end
	bAvg[k] = bCalc
	
	--timer
	el=(el*eli+(os.clock()-st))/(eli+1);st4=os.clock()
	--timer
	
	if tonumber(avgSize) > 1 then
		for i=1,bands do
			local out = 0
			if avgType == 1 then
				for j=1,avgSize do
					out = out + (bAvg[j][i] or 0)
				end
				c[i] = out * avgConst
			elseif avgType == 2 then
				k = avgIndex + 1
				for j=1,avgSize do
					out = out + (bAvg[k][i] or 0) * j
					k = k % avgSize + 1
				end
				c[i] = out * avgConst
			elseif avgType == 3 then
				k = avgIndex + 1
				avgWeight = 0
				weight = 1
				for j=1,avgSize do
					out = out + (bAvg[k][i] or 0) * weight
					weight = weight * avgBase
					k = k % avgSize + 1
				end
				c[i] = out * avgConst
			else
				c[i] = bAvg[k][i]
			end
		end
	else
		c = bAvg[k]
	end
	
	--timer
	el4=(el4*eli+(os.clock()-st4))/(eli+1);st2=os.clock()
	--timer
	
	if invert == 1 then
		if visType == 1 then
			for i=1,bands do
				SKIN:Bang('!SetOption', 'Shape', 'Shape' .. i+1, 'Rectangle' .. (i-1)*(barSpacing+barWidth)*scale .. ',' .. height*scale .. ',' .. barWidth*scale .. ',' .. (-baseHeight-(trueHeight)*c[bands+1-i])*scale .. '|ExtendColor')
			end
		elseif visType == 2 then
			local p = path
			for i=1,bands do
				p[i*2+1] = (trueHeight-trueHeight*c[bands+1-i])*scale
			end
			SKIN:Bang('!SetOption', 'Shape', 'Path', table.concat(p))
		end
	else
		if visType == 1 then
			for i=1,bands do
				SKIN:Bang('!SetOption', 'Shape', 'Shape' .. i+1, 'Rectangle' .. (i-1)*(barSpacing+barWidth)*scale .. ',' .. height*scale .. ',' .. barWidth*scale .. ',' .. (-baseHeight-(trueHeight)*c[i])*scale .. '|ExtendColor')
			end
		elseif visType == 2 then
			local p = path
			for i=1,bands do
				p[i*2+1] = (trueHeight-trueHeight*c[i])*scale
			end
			SKIN:Bang('!SetOption', 'Shape', 'Path', table.concat(p))
		end
	end
	
	--timer
	el2=(el2*eli+(os.clock()-st2))/(eli+1);el3=(el3*eli+(os.clock()-st3))/(eli+1);SKIN:Bang('!SetOption','UpdateTime','Text',string.format("%.3f",el*1000)..' / '..string.format("%.3f",el4*1000)..' / '..string.format("%.3f",el2*1000)..' ('..string.format("%.3f",(el+el4+el2)*1000)..' -> '..string.format("%.2f",el3*1000)..')');st3=os.clock()
	eli=eli+1
	--timer
	
end